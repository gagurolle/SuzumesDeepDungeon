name: Production Deployment

on:
  push:
    branches: [master]

jobs:

  deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Identify current user
      run: whoami
  
    # Создаем директории вместо volume create
    - name: Create data directories
      run: |
        New-Item -ItemType Directory -Force -Path C:\docker_data\db
        New-Item -ItemType Directory -Force -Path C:\docker_data\logs
        
    - name: Test Docker access
      run: |
        docker version
        docker ps
    # Исправленные команды для Windows
    - name: Build and deploy containers
      run: |
        docker compose -f docker-compose.prod.yml down
        docker compose -f docker-compose.prod.yml build --no-cache
        docker compose -f docker-compose.prod.yml up -d
        
    - name: Apply database migrations
      run: docker exec backend dotnet SuzumesDeepDungeon.dll --migrate
